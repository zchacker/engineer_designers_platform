<!DOCTYPE html>
<html>
<head>
  <title>Audio Room Chat</title>
</head>
<body>
  <h1>Audio Room Chat</h1>
  <button onclick="joinRoom()">Join Room</button>
  <div id="remoteAudioContainer"></div>
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js" integrity="sha384-2huaZvOR9iDzHqslqwpR87isEmrfxqyWOF7hr7BY6KG0+hVKLoEXMPUJw3ynWuhO" crossorigin="anonymous"></script>
  <script>
    const socket = io();
    const roomId = 'audio_room';
    let localStream;
    const peers = {};

    function joinRoom() {
      navigator.mediaDevices.getUserMedia({ audio: true })
        .then(stream => {
          localStream = stream;
          socket.emit('join-room', roomId);
          socket.on('user-connected', userId => {
            connectToNewUser(userId, stream);
          });

          socket.on('signal', async (data) => {
            const peer = peers[data.from];
            if (peer) {
              peer.signal(data.signal);
            }
          });

          socket.on('user-disconnected', userId => {
            if (peers[userId]) peers[userId].destroy();
          });
        });
    }

    function connectToNewUser(userId, stream) {
      const peer = new SimplePeer({
        initiator: true,
        trickle: false,
        stream: stream
      });

      peer.on('signal', signal => {
        socket.emit('signal', { to: userId, from: socket.id, signal: signal });
      });

      peer.on('stream', remoteStream => {
        const audioElement = document.createElement('audio');
        audioElement.srcObject = remoteStream;
        audioElement.autoplay = true;
        document.getElementById('remoteAudioContainer').appendChild(audioElement);
      });

      peers[userId] = peer;
    }
  </script>
  <script src="https://cdn.jsdelivr.net/npm/simple-peer@9.11.0/simplepeer.min.js"></script>
</body>
</html>